<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Habit & Routine Tracker ‚Äî PRO (PWA + IndexedDB + PIN)</title>

  <!-- PWA & metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#60a5fa">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icon-512.png">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon-180.png">

  <!-- Social -->
  <meta property="og:title" content="Habit & Routine Tracker">
  <meta property="og:description" content="Seguimiento de h√°bitos simple, offline y privado. PWA + IndexedDB + PIN + backups.">
  <meta property="og:image" content="assets/og-image.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --card:#0b1225; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px }

    html,body{height:100%; min-height:-webkit-fill-available}
    body{
      margin:0; font:16px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b1225,#0f172a 30%,#0b1225);
      padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
      -webkit-text-size-adjust:100%; touch-action:manipulation;

      /* iOS viewport robusto */
      min-height: calc(var(--vh, 1vh) * 100);
      overscroll-behavior-y: contain;
      overflow-x: hidden;
    }
    /* Si el navegador soporta estas unidades, las usamos (el √∫ltimo bloque que aplique gana) */
    @supports (height: 100svh) { body { min-height: 100svh; } }
    @supports (height: 100dvh) { body { min-height: 100dvh; } }

    *{-webkit-tap-highlight-color:transparent}
    *, *::before, *::after{ box-sizing: border-box; }

    .container{max-width:1024px;margin:0 auto;padding:24px; padding-left:calc(24px + env(safe-area-inset-left)); padding-right:calc(24px + env(safe-area-inset-right))}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:20px;font-weight:700;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{background:var(--panel);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:999px;cursor:pointer}
    .tab-btn[aria-selected="true"]{outline:2px solid var(--brand)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card>.p{padding:16px}
    @media(min-width:720px){.half{grid-column:span 6}.third{grid-column:span 4}}
    .row{display:flex;align-items:center;gap:12px}
    .chip{font-size:12px;color:#0b1225;background:var(--brand);padding:2px 8px;border-radius:999px}
    .muted{color:var(--muted)}
    .spacer{flex:1}
    .btn{background:var(--brand);color:#081226;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#0b1225;color:var(--text);border:1px solid var(--border)}
    .btn.danger{background:var(--bad);color:white}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    input[type="text"], input[type="number"], input[type="password"], select, textarea{width:100%;background:#0b1225;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .item .streak{font-size:12px;color:var(--muted)}
    .heat{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .sq{width:18px;height:18px;border-radius:4px;background:#0d1b33;border:1px solid var(--border)}
    .sq.on{background:#22c55e}
    .small{font-size:12px}
    .footer{margin-top:24px;color:var(--muted);font-size:12px}
    .tag-AM{color:#08344a;background:#7dd3fc}
    .tag-PM{color:#3a0a2a;background:#f9a8d4}
    .tag-Any{color:#07361b;background:#86efac}
    .dow{display:flex; gap:6px; flex-wrap:wrap}
    .dow button{border:1px solid var(--border); background:#0b1225; color:#e5e7eb; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px}
    .dow button[aria-pressed="true"]{background:#14324d; outline:1px solid var(--brand)}
    .pill{font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px}
    .drag{cursor:grab; user-select:none}
    .archived{opacity:.6; filter:saturate(.6)}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(20px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0b1225;border:1px solid var(--border);box-shadow:var(--shadow);padding:10px 14px;border-radius:10px;display:none;gap:8px;align-items:center;z-index:9999}
    .toast.show{display:flex}

    /* Month heat calendar */
    .month{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cell{height:20px;border-radius:4px;border:1px solid var(--border);background:#0d1b33}
    .lvl1{background:#214d2b}
    .lvl2{background:#2f7d3e}
    .lvl3{background:#22c55e}
    .legend{display:flex;gap:8px;align-items:center}
    .legend .box{width:16px;height:16px;border-radius:4px;border:1px solid var(--border);}

    /* iOS reorder fallback */
    .reorder{display:none}
    body.touch .reorder{display:flex; gap:6px}
    .reorder .btn{padding:6px 8px}

    /* Lock overlay */
    #lock{position:fixed;inset:0;background:rgba(5,10,22,.75);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:99999; min-height:calc(var(--vh,1vh)*100)}
    #lock .panel{width:min(420px,92vw);background:#0b1225;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:18px}
    #lock h3{margin:0 0 6px 0}
    #lock .hint{color:var(--muted);font-size:12px}

    /* --- Fix layout H√°bitos (iPhone/estrecho) --- */
    .item{ flex-wrap: wrap; align-items: flex-start; }
    .item > input[type="text"]{ flex: 1 1 220px; min-width: 160px; }
    .item > select{ flex: 0 0 92px; }
    .item > input[type="number"]{ flex: 0 0 90px; }
    .dow{ flex: 1 1 240px; }           /* que pueda bajar de l√≠nea */
    .btn{ flex-shrink: 0; }            /* que no se aplasten los botones */
    .actions{ display:flex; gap:8px; margin-left:auto; flex: 0 0 auto; }
    @media (max-width: 430px){
      .actions{ flex-basis: 100%; justify-content: flex-end; margin-top: 8px; }
      .dow{ order: 5; }                /* deja los d√≠as antes de las acciones en m√≥vil */
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">Habit & Routine Tracker</div>
        <div class="subtitle" id="greeting">Buenos d√≠as</div>
      </div>
      <nav class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab-btn" role="tab" id="tab-today" aria-selected="true" onclick="showTab('today')">Hoy</button>
        <button class="tab-btn" role="tab" id="tab-habits" aria-selected="false" onclick="showTab('habits')">H√°bitos</button>
        <button class="tab-btn" role="tab" id="tab-stats" aria-selected="false" onclick="showTab('stats')">Estad√≠sticas</button>
        <button class="tab-btn" role="tab" id="tab-review" aria-selected="false" onclick="showTab('review')">Revisi√≥n</button>
        <button class="tab-btn" role="tab" id="tab-backup" aria-selected="false" onclick="showTab('backup')">Copia/Restaurar</button>
      </nav>
    </header>

    <main class="grid">
      <!-- HOY -->
      <section id="panel-today" class="card">
        <div class="p">
          <div class="row" style="margin-bottom:10px">
            <div class="chip" id="daypart">AM</div>
            <div class="muted" id="today-date"></div>
            <span class="pill" id="persist-note" hidden>‚ö†Ô∏è A√±ade a Inicio para m√°s estabilidad</span>
            <div class="spacer"></div>
            <button class="btn secondary" onclick="toggleDaypartFilter()" title="Alternar filtro AM/PM">Cambiar AM/PM</button>
          </div>
          <div class="list" id="today-list"></div>
          <div class="footer">Si el h√°bito tiene objetivo &gt; 1, usa +/‚àí. La racha sube cuando alcanzas el objetivo del d√≠a.</div>
        </div>
      </section>

      <!-- H√ÅBITOS -->
      <section id="panel-habits" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Tus h√°bitos</h3>
          <div class="list" id="habit-list"></div>
          <hr style="border-color:var(--border); margin:16px 0"/>
          <div class="grid">
            <div class="half card" style="background:transparent; border:0; box-shadow:none">
              <div class="p">
                <h4 style="margin-top:0">A√±adir h√°bito</h4>
                <div class="row" style="gap:10px; align-items:flex-start; flex-wrap:wrap">
                  <input id="new-name" type="text" placeholder="Ej.: T√© verde" />
                  <select id="new-tag" style="max-width:140px">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                    <option value="Any">Cualquiera</option>
                  </select>
                  <input id="new-goal" type="number" value="1" min="1" step="1" style="max-width:120px" title="Objetivo diario (veces)" />
                  <button class="btn" onclick="addHabitFromUI()">A√±adir</button>
                </div>
                <div class="small muted" style="margin-top:6px">Puedes ajustar los d√≠as activos (L‚ÄìD) despu√©s.</div>
              </div>
            </div>
            <div class="half card" style="background:transparent; border:0; box-shadow:none">
              <div class="p">
                <h4 style="margin-top:0">Sugerencias</h4>
                <div class="row" style="flex-wrap:wrap; gap:8px">
                  <button class="tab-btn" onclick="quickAdd('T√© verde','AM')">T√© verde</button>
                  <button class="tab-btn" onclick="quickAdd('Caminata 30 min','AM')">Caminata 30‚Ä≤</button>
                  <button class="tab-btn" onclick="quickAdd('English 15','Any')">English 15</button>
                  <button class="tab-btn" onclick="quickAdd('Shutdown checklist','PM')">Shutdown</button>
                  <button class="tab-btn" onclick="quickAdd('Infusi√≥n de hinojo','PM')">Infusi√≥n hinojo</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ESTAD√çSTICAS -->
      <section id="panel-stats" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Estad√≠sticas</h3>
          <div id="stats-wrap" class="list"></div>
          <hr style="border-color:var(--border); margin:12px 0"/>
          <h4>Este mes</h4>
          <div class="month" id="month-heat"></div>
          <div class="legend small" style="margin-top:8px">
            <span class="muted">Adherencia por d√≠a:</span>
            <span class="box"></span>
            <span class="box lvl1"></span>
            <span class="box lvl2"></span>
            <span class="box lvl3"></span>
          </div>
        </div>
      </section>

      <!-- REVISI√ìN SEMANAL -->
      <section id="panel-review" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Revisi√≥n semanal</h3>
          <div class="small muted" id="week-label"></div>
          <div class="grid" style="margin-top:8px">
            <div class="half">
              <div class="card"><div class="p">
                <label class="small">Qu√© funcion√≥</label>
                <textarea id="rev-good" rows="3"></textarea>
                <label class="small">Qu√© ajusto</label>
                <textarea id="rev-adj" rows="3"></textarea>
                <label class="small">Un win</label>
                <textarea id="rev-win" rows="2"></textarea>
                <div class="row" style="margin-top:8px">
                  <button class="btn" onclick="saveReview()">Guardar</button>
                  <button class="btn secondary" onclick="clearReviewForm()">Limpiar</button>
                </div>
              </div></div>
            </div>
            <div class="half">
              <div class="card"><div class="p">
                <h4 style="margin-top:0">Historial</h4>
                <div id="rev-list" class="list"></div>
              </div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- BACKUP + PRIVACIDAD -->
      <section id="panel-backup" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Copia de seguridad / Restaurar</h3>
          <div class="grid">
            <div class="half">
              <div class="card"><div class="p">
                <p class="muted small">Exporta tus datos (copia/pega, descarga o comparte).</p>
                <textarea id="export-box" rows="8" readonly></textarea>
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="doExport()">Generar exportaci√≥n</button>
                  <button class="btn secondary" onclick="copyExport()">Copiar</button>
                  <button class="btn" onclick="downloadExport()">Descargar backup.json</button>
                  <button class="btn" onclick="shareExport()">Compartir‚Ä¶</button>
                </div>
                <hr style="border-color:var(--border); margin:12px 0"/>
                <h4 style="margin:0">Backup cifrado (AES-GCM)</h4>
                <input id="enc-pass" type="password" placeholder="Contrase√±a" />
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="downloadEncrypted()">Descargar .hrz</button>
                  <button class="btn secondary" onclick="shareEncrypted()">Compartir .hrz</button>
                </div>
              </div></div>
            </div>
            <div class="half">
              <div class="card"><div class="p">
                <p class="muted small">Restaurar desde archivo o pegando JSON. Puedes <strong>fusionar</strong> o <strong>reemplazar</strong>.</p>
                <div class="row" style="flex-wrap:wrap">
                  <input id="import-file" type="file" accept="application/json,.hrz" />
                  <label class="small"><input type="checkbox" id="merge-toggle" /> Fusionar (merge) en lugar de reemplazar</label>
                </div>
                <textarea id="import-box" rows="6" placeholder="Pega aqu√≠ tu JSON‚Ä¶"></textarea>
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="importFromFile()">Importar archivo</button>
                  <button class="btn danger" onclick="doImport()">Restaurar (pegar JSON)</button>
                  <button class="btn secondary" onclick="importEncrypted()">Importar .hrz</button>
                </div>
              </div></div>
            </div>
          </div>

          <hr style="border-color:var(--border); margin:16px 0"/>
          <h3 style="margin:0">Privacidad / Seguridad</h3>
          <p class="small muted">Tus datos viven s√≥lo en este dispositivo. Puedes bloquear la app con un <strong>PIN</strong> local (4‚Äì8 d√≠gitos). Si lo olvidas, s√≥lo podr√°s recuperar con tu backup.</p>
          <div class="grid">
            <div class="half">
              <div class="card"><div class="p">
                <h4 style="margin-top:0">PIN de apertura</h4>
                <input id="pin-1" inputmode="numeric" pattern="[0-9]*" type="password" placeholder="PIN (4‚Äì8 d√≠gitos)" maxlength="8" />
                <input id="pin-2" inputmode="numeric" pattern="[0-9]*" type="password" placeholder="Repite el PIN" maxlength="8" style="margin-top:8px" />
                <input id="pin-hint" type="text" placeholder="Pista (opcional)" style="margin-top:8px" />
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="enablePin()">Activar/Actualizar PIN</button>
                  <button class="btn secondary" onclick="disablePin()">Quitar PIN</button>
                </div>
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <label class="small">Auto-bloqueo: </label>
                  <select id="autolock" style="max-width:180px" onchange="setAutoLock(this.value)">
                    <option value="0">Nunca</option>
                    <option value="5">5 min</option>
                    <option value="10" selected>10 min</option>
                    <option value="30">30 min</option>
                  </select>
                </div>
              </div></div>
            </div>
            <div class="half">
              <div class="card"><div class="p">
                <h4 style="margin-top:0">Avisos</h4>
                <ul class="small">
                  <li>Instala la app (PWA) para reducir purgados de datos.</li>
                  <li>Haz backups regulares (mejor cifrados con contrase√±a).</li>
                  <li>Si olvidas el PIN, puedes <strong>borrar datos</strong> desde la pantalla de bloqueo y restaurar desde backup.</li>
                </ul>
              </div></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="footer" style="text-align:center; margin-top:24px">
      Local-first con <strong>IndexedDB</strong> (persistencia) y copia en <code>localStorage</code>. PWA instalable y offline en <strong>HTTPS</strong> o <code>localhost</code>.
    </div>
  </div>

  <div class="toast" id="toast"><span id="toast-msg">Hecho</span> <button class="btn secondary" onclick="undoAction()">Deshacer</button></div>

  <!-- Lock overlay -->
  <div id="lock">
    <div class="panel">
      <h3>üîí Desbloquear</h3>
      <div class="small muted">Introduce tu PIN para abrir la app.</div>
      <input id="lock-pin" inputmode="numeric" pattern="[0-9]*" type="password" placeholder="PIN" maxlength="8" style="margin-top:8px"/>
      <div class="row" style="margin-top:8px; flex-wrap:wrap">
        <button class="btn" onclick="tryUnlock()">Desbloquear</button>
        <button class="btn secondary" onclick="showHint()">Ver pista</button>
        <button class="btn danger" onclick="confirmNuke()">Borrar datos‚Ä¶</button>
      </div>
      <div id="lock-msg" class="hint" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ===== Utilidades
    const pad = n => (n<10? '0'+n : ''+n);
    function todayStr(){ const d = new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function dateOffsetStr(days){ const d = new Date(); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function humanDate(){ return new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); }
    function todayDow(){ return new Date().getDay(); }

    // ===== IndexedDB + localStorage
    const DB_NAME = 'habitDBv5';
    const STORE = 'kv';
    let state = null;

    function openDB(){ return new Promise((resolve, reject)=>{ const req = indexedDB.open(DB_NAME, 1); req.onupgradeneeded = (e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'key'}); }; req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error); }); }
    async function idbGet(key){ const db = await openDB(); return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const rq=st.get(key); rq.onsuccess=()=>resolve(rq.result?rq.result.value:undefined); rq.onerror=()=>reject(rq.error); }); }
    async function idbSet(key,value){ const db = await openDB(); return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); st.put({key,value}); tx.oncomplete=()=>resolve(); tx.onerror=()=>reject(tx.error); }); }

    function defaultState(){ return {lang:'es', habits:[], completions:{}, createdAt: todayStr(), lastOpen: todayStr(), reviews:[], order:[], archived:[], notifications:{enabled:true,lastPing:0}, security:{autoLockMins:10} }; }
    function migrate(old){ const s = JSON.parse(JSON.stringify(old||defaultState())); s.lang = s.lang||'es'; s.habits = Array.isArray(s.habits)? s.habits : []; s.completions = s.completions && typeof s.completions==='object'? s.completions : {}; s.reviews = Array.isArray(s.reviews)? s.reviews : []; s.order = Array.isArray(s.order)? s.order : s.habits.map(h=>h.id); s.archived = Array.isArray(s.archived)? s.archived : []; s.notifications = s.notifications||{enabled:true,lastPing:0}; s.security = s.security||{autoLockMins:10}; for(const h of s.habits){ if(!('tag' in h)) h.tag='Any'; if(!Array.isArray(h.days)) h.days=[]; if(typeof h.goal !== 'number' || h.goal < 1) h.goal = 1; if(typeof h.archived!=='boolean') h.archived=false; } for(const id in s.completions){ const obj=s.completions[id]||{dates:{}}; if(!obj.dates) obj.dates={}; for(const d in obj.dates){ if(obj.dates[d]===true) obj.dates[d]=1; if(obj.dates[d]===false) delete obj.dates[d]; } } return s; }

    async function loadState(){ try{ const fromIDB = await idbGet('state'); if(fromIDB) return migrate(fromIDB); const raw = localStorage.getItem('habitDataV1'); if(raw) return migrate(JSON.parse(raw)); return defaultState(); }catch(e){ const raw=localStorage.getItem('habitDataV1'); return raw?migrate(JSON.parse(raw)):defaultState(); } }
    async function saveState(){ try{ state.lastOpen=todayStr(); await idbSet('state', state); }catch{} try{ localStorage.setItem('habitDataV1', JSON.stringify(state)); }catch{} broadcastState(); }

    // ===== Multitab
    const channel = ('BroadcastChannel' in self) ? new BroadcastChannel('hr-sync') : null;
    function broadcastState(){ if(channel) channel.postMessage({type:'state', state}); }
    if(channel){ channel.onmessage = (e)=>{ if(e.data && e.data.type==='state'){ state = migrate(e.data.state); renderAll(); } }; }

    // ===== Persistencia (reduce purgados)
    async function requestPersistence(){
      if(!('storage' in navigator) || !navigator.storage.persist) return;
      try{
        const persisted = await navigator.storage.persisted();
        if(!persisted){
          const ok = await navigator.storage.persist();
          if(!ok){ document.getElementById('persist-note').hidden=false; }
        }
      }catch{}
    }

    // ===== H√°bitos CRUD
    function addHabit(name, tag, goal=1){ if(!name) return; const id='h'+Math.random().toString(36).slice(2,9); const h={id,name,tag,days:[],goal:Math.max(1,parseInt(goal)||1),archived:false}; state.habits.push(h); state.order.push(id); state.completions[id]={dates:{}}; saveState(); renderAll(); }
    function quickAdd(name, tag){ addHabit(name, tag, 1); showTab('habits'); }
    function addHabitFromUI(){ const name=document.getElementById('new-name').value.trim(); const tag=document.getElementById('new-tag').value; const goal=parseInt(document.getElementById('new-goal').value)||1; addHabit(name,tag,goal); document.getElementById('new-name').value=''; document.getElementById('new-goal').value='1'; }
    function deleteHabit(id){ if(!confirm('¬øEliminar este h√°bito? Se perder√° su historial.')) return; state.habits=state.habits.filter(h=>h.id!==id); state.order=state.order.filter(x=>x!==id); delete state.completions[id]; saveState(); renderAll(); }
    function renameHabit(id, newName){ const h=state.habits.find(h=>h.id===id); if(!h) return; h.name=newName; saveState(); renderAll(); }
    function changeTag(id, newTag){ const h=state.habits.find(h=>h.id===id); if(!h) return; h.tag=newTag; saveState(); renderAll(); }
    function toggleDay(id, dow){ const h=state.habits.find(h=>h.id===id); if(!h) return; const idx=(h.days||[]).indexOf(dow); if(idx>=0) h.days.splice(idx,1); else h.days.push(dow); h.days.sort(); saveState(); renderAll(); }
    function setGoal(id, goal){ const h=state.habits.find(h=>h.id===id); if(!h) return; const g=Math.max(1, parseInt(goal)||1); h.goal=g; saveState(); renderAll(); }
    function archiveHabit(id, arch){ const h=state.habits.find(h=>h.id===id); if(!h) return; h.archived=arch; saveState(); renderAll(); }

    // ===== Drag & drop + fallback ‚Üë‚Üì
    let dragId=null;
    function onDragStart(e,id){ dragId=id; e.dataTransfer.effectAllowed='move'; }
    function onDragOver(e,id){ e.preventDefault(); const a=state.order.indexOf(dragId), b=state.order.indexOf(id); if(a===-1||b===-1||a===b) return; state.order.splice(b,0,state.order.splice(a,1)[0]); renderHabits(); }
    function onDragEnd(){ saveState(); dragId=null; }
    function moveUp(id){ const i = state.order.indexOf(id); if(i>0){ state.order.splice(i-1,0,state.order.splice(i,1)[0]); saveState(); renderHabits(); } }
    function moveDown(id){ const i = state.order.indexOf(id); if(i>=0 && i<state.order.length-1){ state.order.splice(i+1,0,state.order.splice(i,1)[0]); saveState(); renderHabits(); } }

    // ===== Contadores y UNDO
    let toastTimer=null, toastUndo=null;
    function showToast(msg, undoFn){ const t=document.getElementById('toast'); document.getElementById('toast-msg').textContent=msg; t.classList.add('show'); clearTimeout(toastTimer); toastUndo = undoFn || null; toastTimer = setTimeout(()=>{ t.classList.remove('show'); toastUndo=null; }, 5000); }
    function undoAction(){ if(toastUndo){ toastUndo(); } document.getElementById('toast').classList.remove('show'); toastUndo=null; }

    function getCount(id, date=todayStr()){ const comp=state.completions[id]||{dates:{}}; return parseInt(comp.dates[date]||0); }
    function setCount(id, count, date=todayStr()){ if(!state.completions[id]) state.completions[id]={dates:{}}; const prev = getCount(id,date); if(count<=0) delete state.completions[id].dates[date]; else state.completions[id].dates[date]=count; saveState(); renderAll(); showToast('Guardado', ()=>{ setCount(id, prev, date); }); }
    function inc(id){ const h=state.habits.find(h=>h.id===id); if(!h) return; setCount(id, Math.min(getCount(id)+1, h.goal)); }
    function dec(id){ setCount(id, Math.max(getCount(id)-1, 0)); }
    function toggleDone(id){ const h=state.habits.find(h=>h.id===id); if(!h) return; const done = getCount(id)>=h.goal; setCount(id, done?0:h.goal); }

    // ===== Rachas / adherencia / mes
    function isDoneOn(id, date){ const h=state.habits.find(h=>h.id===id); if(!h) return false; const cnt=parseInt((state.completions[id]||{dates:{}}).dates[date]||0); return cnt >= h.goal; }
    function computeStreak(id){ let streak=0; for(let i=0;i<3650;i++){ const ds=dateOffsetStr(-i); if(isDoneOn(id, ds)) streak++; else break; } return streak; }
    function last7(id){ const arr=[]; for(let i=6;i>=0;i--){ const ds=dateOffsetStr(-i); arr.push(isDoneOn(id, ds)); } return arr; }
    function adherence(id, days=30){ let ok=0, total=0; for(let i=0;i<days;i++){ const ds=dateOffsetStr(-i); const h=state.habits.find(h=>h.id===id); if(!h || h.archived) continue; const dow = new Date(Date.parse(ds)).getDay(); if(h.days.length && !h.days.includes(dow)) continue; total++; if(isDoneOn(h.id, ds)) ok++; } return total? Math.round(ok*100/total):0; }
    function adherenceByPart(days=30){ let amT=0, amOk=0, pmT=0, pmOk=0; for(const h of state.habits){ if(h.archived) continue; for(let i=0;i<days;i++){ const ds=dateOffsetStr(-i); const dow = new Date(Date.parse(ds)).getDay(); if(h.days.length && !h.days.includes(dow)) continue; if(h.tag==='PM'){ pmT++; if(isDoneOn(h.id, ds)) pmOk++; } else if(h.tag==='AM'){ amT++; if(isDoneOn(h.id, ds)) amOk++; } else { amT++; pmT++; if(isDoneOn(h.id, ds)){ amOk++; pmOk++; } } } } return {am: amT?Math.round(amOk*100/amT):0, pm: pmT?Math.round(pmOk*100/pmT):0}; }

    // ===== Render
    function showTab(name){
      for(const p of ['today','habits','stats','review','backup']){
        const panel=document.getElementById('panel-'+p);
        const btn=document.getElementById('tab-'+p);
        const selected=(p===name);
        if(panel) panel.hidden=!selected;
        if(btn) btn.setAttribute('aria-selected', selected);
      }
      if(name==='backup') doExport();
      if(name==='stats') renderMonthHeat();
      if(name==='review') renderReview();
    }
    function currentDaypart(){ const h=new Date().getHours(); return (h < 14) ? 'AM' : 'PM'; }
    let filterDaypart=currentDaypart();
    function toggleDaypartFilter(){ filterDaypart=(filterDaypart==='AM'?'PM':'AM'); renderToday(); }
    function renderGreeting(){
      const hour=new Date().getHours();
      const g=document.getElementById('greeting');
      const dateEl=document.getElementById('today-date');
      dateEl.textContent=humanDate();
      g.textContent = (hour<12?'Buenos d√≠as':(hour<20?'Buenas tardes':'Buenas noches'));
      const chip=document.getElementById('daypart');
      chip.textContent=filterDaypart;
      chip.className='chip tag-'+filterDaypart;
    }
    function isActiveToday(h){ if(h.archived) return false; if(!h.days || h.days.length===0) return true; return h.days.includes(todayDow()); }

    function renderToday(){
      renderGreeting(); const wrap=document.getElementById('today-list'); wrap.innerHTML='';
      const list=state.order.map(id=>state.habits.find(h=>h.id===id)).filter(Boolean).filter(h=>isActiveToday(h) && (filterDaypart==='AM' ? (h.tag==='AM'||h.tag==='Any') : (h.tag==='PM'||h.tag==='Any')));
      if(list.length===0){ wrap.innerHTML = `<div class="muted">No hay h√°bitos para este tramo. Ajusta d√≠as/objetivos en <strong>H√°bitos</strong>.</div>`; return; }
      for(const h of list){
        const done=isDoneOn(h.id,todayStr()); const count=getCount(h.id); const need=h.goal||1; const li=document.createElement('div'); li.className='item';
        const controls = (need>1)
          ? `<div class="row"><button class="btn secondary" onclick="dec('${h.id}')">‚àí</button><div>${count}/${need}</div><button class="btn" onclick="inc('${h.id}')">+</button></div>`
          : `<input type="checkbox" ${done?'checked':''} onclick="toggleDone('${h.id}')" />`;
        li.innerHTML = `
          <div class="row" style="gap:12px; align-items:center">
            ${controls}
            <div>
              <div><strong>${escapeHtml(h.name)}</strong> 
                <span class="chip tag-${h.tag}">${h.tag}</span> 
                <span class="pill">Objetivo: ${need}</span>
              </div>
              <div class="streak">Racha: <strong>${computeStreak(h.id)}</strong> d√≠a(s)</div>
            </div>
            <div class="spacer"></div>
            <div class="heat" aria-label="√öltimos 7 d√≠as">
              ${last7(h.id).map(v=>`<div class="sq ${v?'on':''}"></div>`).join('')}
            </div>
          </div>`;
        wrap.appendChild(li);
      }
    }

    function habitRow(h){
      const DOW=['D','L','M','X','J','V','S']; const archClass = h.archived?'archived':'';
      return `
      <div class="item ${archClass}" draggable="true"
           ondragstart="onDragStart(event,'${h.id}')"
           ondragover="onDragOver(event,'${h.id}')"
           ondragend="onDragEnd()">
        <div class="drag" title="Drag">‚†ø</div>
        <div class="reorder">
          <button class="btn secondary" onclick="moveUp('${h.id}')">‚Üë</button>
          <button class="btn secondary" onclick="moveDown('${h.id}')">‚Üì</button>
        </div>

        <input type="text" value="${escapeHtml(h.name)}"
               onblur="renameHabit('${h.id}', this.value.trim())" />

        <select onchange="changeTag('${h.id}', this.value)">
          <option ${h.tag==='AM'?'selected':''}>AM</option>
          <option ${h.tag==='PM'?'selected':''}>PM</option>
          <option value="Any" ${h.tag==='Any'?'selected':''}>Cualquiera</option>
        </select>

        <input type="number" min="1" step="1" value="${h.goal||1}"
               style="max-width:100px" title="Objetivo diario"
               onblur="setGoal('${h.id}', this.value)" />

        <div class="spacer"></div>

        <div class="dow">
          ${DOW.map((lab,idx)=>`<button type="button" aria-pressed="${(h.days||[]).includes(idx)}"
             onclick="toggleDay('${h.id}',${idx})">${lab}</button>`).join('')}
        </div>

        <div class="spacer"></div>

        <div class="actions">
          <button class="btn secondary" onclick="archiveHabit('${h.id}', ${!h.archived})">
            ${h.archived?'Desarchivar':'Archivar'}
          </button>
          <button class="btn danger" onclick="deleteHabit('${h.id}')">Eliminar</button>
        </div>
      </div>`;
    }
    function renderHabits(){
      const wrap=document.getElementById('habit-list'); wrap.innerHTML='';
      if(state.habits.length===0){ wrap.innerHTML = `<div class="muted">A√∫n no tienes h√°bitos. Usa Sugerencias o a√±ade el tuyo.</div>`; return; }
      for(const id of state.order){ const h = state.habits.find(h=>h.id===id); if(!h) continue; wrap.insertAdjacentHTML('beforeend', habitRow(h)); }
    }

    function renderStats(){
      const wrap=document.getElementById('stats-wrap'); wrap.innerHTML='';
      if(state.habits.length===0){ wrap.innerHTML = `<div class="muted">Nada que mostrar todav√≠a.</div>`; return; }
      const byPart = adherenceByPart(30);
      for(const h of state.habits){
        if(h.archived) continue;
        const row=document.createElement('div'); row.className='item';
        const streak=computeStreak(h.id); const adh=adherence(h.id,30);
        row.innerHTML = `
          <div>
            <div><strong>${escapeHtml(h.name)}</strong> <span class=\"chip tag-${h.tag}\">${h.tag}</span> <span class="pill">Obj ${h.goal||1}/d√≠a</span></div>
            <div class="small muted">Adherencia 30 d√≠as: <strong>${adh}%</strong> ‚Ä¢ Racha: <strong>${streak}</strong></div>
          </div>
          <div class="spacer"></div>
          <div class="heat">${last7(h.id).map(v=>`<div class="sq ${v?'on':''}"></div>`).join('')}</div>`;
        wrap.appendChild(row);
      }
      const summary = document.createElement('div'); summary.className='small muted'; summary.style.marginTop='6px';
      summary.textContent = `Adherencia AM: ${byPart.am}% ‚Ä¢ Adherencia PM: ${byPart.pm}%`;
      wrap.appendChild(summary);
    }

    function renderMonthHeat(){
      const cont = document.getElementById('month-heat'); cont.innerHTML='';
      const now = new Date(); const y=now.getFullYear(), m=now.getMonth();
      const first = new Date(y,m,1); const last = new Date(y,m+1,0);
      const startDow = first.getDay(); const days = last.getDate(); const cells=[];
      for(let i=0;i<startDow;i++) cells.push(null);
      for(let d=1; d<=days; d++){
        const date=`${y}-${pad(m+1)}-${pad(d)}`;
        let active=0, done=0;
        for(const h of state.habits){
          if(h.archived) continue;
          const dow = new Date(y,m,d).getDay();
          if(h.days.length && !h.days.includes(dow)) continue;
          active++; if(isDoneOn(h.id, date)) done++;
        }
        const ratio = active? (done/active) : 0;
        let cls='cell';
        if(ratio>0 && ratio<=0.33) cls+=' lvl1'; else if(ratio<=0.66) cls+=' lvl2'; else if(ratio>0.66) cls+=' lvl3';
        cells.push({cls, date});
      }
      for(const c of cells){
        const div=document.createElement('div');
        if(!c){ div.className='cell'; cont.appendChild(div); continue; }
        div.className=c.cls; div.title=c.date; cont.appendChild(div);
      }
    }

    function mondayOfWeek(d){ const dt = new Date(d); const day = dt.getDay(); const diff = (day+6)%7; dt.setDate(dt.getDate()-diff); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; }
    function renderReview(){
      const label=document.getElementById('week-label'); const monday=mondayOfWeek(new Date()); label.textContent = 'Semana que empieza: '+ monday;
      const list=document.getElementById('rev-list'); list.innerHTML='';
      const items = state.reviews.slice().reverse();
      if(items.length===0){ list.innerHTML = `<div class="muted small">Sin revisiones a√∫n.</div>`; return; }
      for(const r of items){
        const div=document.createElement('div'); div.className='item';
        div.innerHTML = `<div><div><strong>${r.week}</strong></div><div class="small">‚úÖ ${escapeHtml(r.good||'')}<br/>üîß ${escapeHtml(r.adjust||'')}<br/>üèÜ ${escapeHtml(r.win||'')}</div></div>`;
        list.appendChild(div);
      }
    }
    function clearReviewForm(){ document.getElementById('rev-good').value=''; document.getElementById('rev-adj').value=''; document.getElementById('rev-win').value=''; }
    function saveReview(){
      const week=mondayOfWeek(new Date());
      const good=document.getElementById('rev-good').value.trim();
      const adjust=document.getElementById('rev-adj').value.trim();
      const win=document.getElementById('rev-win').value.trim();
      const idx = state.reviews.findIndex(r=>r.week===week);
      const entry={week, good, adjust, win};
      if(idx>=0) state.reviews[idx]=entry; else state.reviews.push(entry);
      saveState(); clearReviewForm(); renderReview(); showToast('Revisi√≥n guardada');
    }

    // ===== Backup / Restore / Crypto
    function doExport(){ const box=document.getElementById('export-box'); box.value=JSON.stringify(state,null,2); }
    function copyExport(){ const box=document.getElementById('export-box'); box.select(); document.execCommand('copy'); }
    function downloadExport(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='habit-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    async function shareExport(){ if(navigator.share){ const file = new File([JSON.stringify(state,null,2)], 'habit-backup.json', {type:'application/json'}); try{ await navigator.share({ files:[file], title:'Habit Backup', text:'Backup JSON' }); }catch(e){} } else { alert('Tu navegador no soporta compartir.'); } }

    function validateImported(obj){ if(!obj || typeof obj!=='object') throw new Error('No es un objeto'); if(!Array.isArray(obj.habits)) throw new Error('Falta array de h√°bitos'); if(typeof obj.completions!=='object') throw new Error('Falta historial'); return migrate(obj); }
    function mergeStates(base, incoming){
      const result = migrate(base); const inc = migrate(incoming);
      const nameMap = new Map(result.habits.map(h=>[h.name.toLowerCase(), h.id]));
      for(const h of inc.habits){
        const key=h.name.toLowerCase();
        if(nameMap.has(key)){
          const id=nameMap.get(key);
          const target = result.habits.find(x=>x.id===id);
          target.goal = Math.max(target.goal||1, h.goal||1);
          target.days = Array.from(new Set([...(target.days||[]), ...(h.days||[])])).sort();
          const tc = result.completions[id] = result.completions[id]||{dates:{}};
          const sc = inc.completions[h.id]||{dates:{}};
          for(const d in sc.dates){ tc.dates[d] = Math.max(parseInt(tc.dates[d]||0), parseInt(sc.dates[d]||0)); }
        } else {
          const newId = 'h'+Math.random().toString(36).slice(2,9);
          result.habits.push({id:newId, name:h.name, tag:h.tag, days:h.days, goal:h.goal, archived:h.archived||false});
          result.order.push(newId);
          const sc = inc.completions[h.id]||{dates:{}};
          result.completions[newId] = {dates:{...sc.dates}};
        }
      }
      const weeks = new Set(result.reviews.map(r=>r.week));
      for(const r of inc.reviews){ if(!weeks.has(r.week)) result.reviews.push(r); }
      return result;
    }

    function importFromFile(){
      const f=document.getElementById('import-file').files[0]; if(!f) return alert('Elige un archivo');
      const r=new FileReader();
      r.onload=()=>{
        const merge=document.getElementById('merge-toggle').checked;
        try{
          let obj;
          if(f.name.endsWith('.hrz')){ alert('Usa "Importar .hrz" con tu contrase√±a.'); return; }
          else { obj=validateImported(JSON.parse(r.result)); }
          state = merge? mergeStates(state, obj) : obj;
          saveState(); renderAll(); alert('Datos importados.');
        }catch(e){ alert('No se pudo importar: '+e.message); }
      };
      r.readAsText(f);
    }
    function doImport(){
      const raw=document.getElementById('import-box').value.trim(); if(!raw) return alert('Pega el JSON a importar.');
      const merge=document.getElementById('merge-toggle').checked;
      if(!merge && !confirm('Esto reemplazar√° todos tus datos. ¬øContinuar?')) return;
      try{
        const obj=validateImported(JSON.parse(raw));
        state = merge? mergeStates(state,obj) : obj;
        saveState(); renderAll(); alert('Datos restaurados.');
      }catch(e){ alert('No se pudo importar: '+e.message); }
    }

    const textEnc = new TextEncoder(); const textDec = new TextDecoder();
    async function deriveKey(pass, salt){
      const baseKey = await crypto.subtle.importKey('raw', textEnc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    }
    function b64a(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
    function a64b(str){ const bin = atob(str); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }
    async function encryptState(pass){
      if(!pass) throw new Error('Falta contrase√±a');
      const salt=crypto.getRandomValues(new Uint8Array(16));
      const iv=crypto.getRandomValues(new Uint8Array(12));
      const key=await deriveKey(pass, salt);
      const data=textEnc.encode(JSON.stringify(state));
      const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, data);
      return JSON.stringify({alg:'AES-GCM', salt:b64a(salt), iv:b64a(iv), ct:b64a(ct)});
    }
    async function decryptState(pass, payload){
      const obj = typeof payload==='string'? JSON.parse(payload) : payload;
      const salt=a64b(obj.salt); const iv=a64b(obj.iv);
      const key=await deriveKey(pass, new Uint8Array(salt));
      const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(iv)}, key, a64b(obj.ct));
      return JSON.parse(textDec.decode(pt));
    }
    async function downloadEncrypted(){
      const pass=document.getElementById('enc-pass').value;
      try{
        const enc=await encryptState(pass);
        const blob=new Blob([enc],{type:'application/octet-stream'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='habit-backup.hrz'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
      }catch(e){ alert('Error: '+e.message); }
    }
    async function shareEncrypted(){
      if(!navigator.share) return alert('Compartir no soportado');
      const pass=document.getElementById('enc-pass').value;
      try{
        const enc=await encryptState(pass);
        const file = new File([enc], 'habit-backup.hrz', {type:'application/octet-stream'});
        await navigator.share({ files:[file], title:'Habit Encrypted Backup', text:'Encrypted .hrz' });
      }catch(e){ if(e.name!=='AbortError') alert('Error: '+e.message); }
    }
    async function importEncrypted(){
      const pass=prompt('Contrase√±a para desencriptar:'); if(!pass) return;
      const f=document.getElementById('import-file').files[0];
      if(!f || !f.name.endsWith('.hrz')) return alert('Elige un archivo .hrz');
      const r=new FileReader();
      r.onload=async()=>{
        try{
          const obj=JSON.parse(r.result); const dec=await decryptState(pass,obj);
          const merge=document.getElementById('merge-toggle').checked;
          state = merge? mergeStates(state,dec) : migrate(dec);
          saveState(); renderAll(); alert('Datos importados.');
        }catch(e){ alert('No se pudo descifrar: '+e.message); }
      };
      r.readAsText(f);
    }

    // ===== PIN & Lock
    async function pinBits(pin, salt){
      const base = await crypto.subtle.importKey('raw', textEnc.encode(pin), 'PBKDF2', false, ['deriveBits']);
      return crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'}, base, 256);
    }
    function setAutoLock(mins){ mins=parseInt(mins)||0; state.security = state.security||{}; state.security.autoLockMins = mins; saveState(); }
    async function enablePin(){
      const p1=document.getElementById('pin-1').value.trim();
      const p2=document.getElementById('pin-2').value.trim();
      const hint=document.getElementById('pin-hint').value.trim();
      if(!/^\d{4,8}$/.test(p1)) return alert('El PIN debe tener 4‚Äì8 d√≠gitos.');
      if(p1!==p2) return alert('Los PIN no coinciden.');
      const salt=crypto.getRandomValues(new Uint8Array(16));
      const bits=await pinBits(p1, salt);
      state.security = state.security||{};
      state.security.pin = { salt: b64a(salt), hash: b64a(bits), hint };
      saveState(); alert('PIN activado/actualizado.');
    }
    function disablePin(){
      if(!state.security || !state.security.pin) return alert('No hay PIN activo.');
      if(!confirm('Quitar PIN de apertura?')) return;
      delete state.security.pin; saveState(); alert('PIN desactivado.'); hideLock();
    }
    async function verifyPin(pin){
      try{
        const sec=state.security && state.security.pin; if(!sec) return true;
        const salt = new Uint8Array(a64b(sec.salt)); const expected = b64a(await pinBits(pin, salt));
        return expected === sec.hash;
      }catch{ return false; }
    }
    function showHint(){ const sec=state.security && state.security.pin; const el=document.getElementById('lock-msg'); el.textContent = (sec && sec.hint) ? ('Pista: '+sec.hint) : 'No hay pista guardada.'; }
    function showLock(msg){
      const o=document.getElementById('lock');
      document.getElementById('lock-pin').value='';
      document.getElementById('lock-msg').textContent=msg||'';
      o.style.display='flex';
      setTimeout(()=>{ const inp=document.getElementById('lock-pin'); inp.focus({preventScroll:false}); if('scrollIntoView' in inp) inp.scrollIntoView({block:'center'}); },100);
    }
    function hideLock(){ const o=document.getElementById('lock'); o.style.display='none'; }
    async function tryUnlock(){
      const pin=document.getElementById('lock-pin').value.trim();
      if(!/^\d{4,8}$/.test(pin)) { document.getElementById('lock-msg').textContent='PIN inv√°lido'; return; }
      const ok = await verifyPin(pin);
      if(ok){ hideLock(); lastUnlockTs = Date.now(); }
      else { document.getElementById('lock-msg').textContent='PIN incorrecto'; }
    }
    function confirmNuke(){ if(!confirm('Esto borrar√° todos los datos locales (h√°bitos e historial). ¬øContinuar?')) return; nukeAllData(); }
    async function nukeAllData(){
      try{
        indexedDB.deleteDatabase(DB_NAME);
        localStorage.removeItem('habitDataV1');
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.filter(k=>k.startsWith('hr-cache-')).map(k=>caches.delete(k)));
        }
        location.reload();
      }catch(e){ alert('No se pudo borrar: '+e.message); }
    }

    // Autolock al volver tras X minutos
    let hiddenAt = 0, lastUnlockTs = 0;
    document.addEventListener('visibilitychange', ()=>{
      const mins = (state && state.security && state.security.autoLockMins) || 0;
      if(document.hidden){ hiddenAt = Date.now(); }
      else if(hiddenAt && mins>0){
        const away = (Date.now()-hiddenAt)/60000;
        if(away >= mins && state.security && state.security.pin){ showLock(); }
        hiddenAt=0;
      }
    });

    // Ajuste del overlay con teclado iOS
    if(window.visualViewport){
      const adjustLock = () => {
        const o = document.getElementById('lock');
        if(!o || o.style.display!=='flex') return;
        const kb = Math.max(0, window.innerHeight - window.visualViewport.height);
        o.style.paddingBottom = `calc(env(safe-area-inset-bottom) + ${kb}px)`;
      };
      visualViewport.addEventListener('resize', adjustLock);
      visualViewport.addEventListener('scroll', adjustLock);
    }

    // ===== Init =====
    (async function init(){
      await requestPersistence();
      state = await loadState();

      // Primer arranque: sugerencias por defecto
      if(!state.habits || state.habits.length===0){
        state = state || defaultState();
        const defaults = [
          {name:'ü•§ Agua al despertar', tag:'AM', goal:1, days:[]},
          {name:'üçµ T√© verde', tag:'AM', goal:1, days:[]},
          {name:'üç≥ Desayuno proteico', tag:'AM', goal:1, days:[]},
          {name:'ü•ó 5 raciones fruta/verdura', tag:'Any', goal:5, days:[]},
          {name:'ü•ú Frutos secos (pu√±ado)', tag:'Any', goal:1, days:[1,2,3,4,5]},
          {name:'üïò Cierre de cocina (‚â•3 h antes)', tag:'PM', goal:1, days:[]},
          {name:'üåø Infusi√≥n de hinojo', tag:'PM', goal:1, days:[]},
          {name:'üö´ Sin alcohol (L‚ÄìJ)', tag:'PM', goal:1, days:[1,2,3,4]},

          {name:'üö∂‚Äç‚ôÄÔ∏è Caminata 45‚Ä≤', tag:'AM', goal:1, days:[]},
          {name:'üö∂‚Äç‚ôÄÔ∏è Caminata 30‚Ä≤', tag:'PM', goal:1, days:[]},
          {name:'üí™ Fuerza 20‚Ä≤', tag:'Any', goal:1, days:[1,3,5]},
          {name:'üßò‚Äç‚ôÄÔ∏è Movilidad 5‚Ä≤', tag:'AM', goal:1, days:[]},
          {name:'üèãÔ∏è‚Äç‚ôÄÔ∏è Core 8‚Ä≤', tag:'Any', goal:1, days:[2,4,6]},
          {name:'üéæ P√°del (semanal)', tag:'Any', goal:1, days:[6]},

          {name:'üá¨üáß English 15', tag:'Any', goal:1, days:[]},
          {name:'üìö Lectura t√©cnica 15‚Ä≤', tag:'Any', goal:1, days:[1,2,3,4]},
          {name:'üß© Curso AEM/skills 20‚Ä≤', tag:'Any', goal:1, days:[2,4]},
          {name:'‚è±Ô∏è Pomodoro 25‚Ä≤ (focus)', tag:'Any', goal:1, days:[1,2,3,4,5]},
          {name:'üìù Diario de aprendizaje (3 bullets)', tag:'PM', goal:1, days:[]},

          {name:'üçΩÔ∏è Reset cocina 5‚Ä≤', tag:'PM', goal:1, days:[]},
          {name:'üõãÔ∏è Sal√≥n recogido 5‚Ä≤', tag:'PM', goal:1, days:[]},
          {name:'üß¥ Ba√±o expr√©s 10‚Ä≤', tag:'Any', goal:1, days:[3,6]},
          {name:'üß∫ Lavadora (semanal)', tag:'Any', goal:1, days:[3]},
          {name:'üßª Toallas (semanal)', tag:'Any', goal:1, days:[6]},
          {name:'üõèÔ∏è S√°banas (quincenal)', tag:'Any', goal:1, days:[0]},
          {name:'üóëÔ∏è Basura/reciclaje', tag:'PM', goal:1, days:[1,3,5]},
          {name:'üîö Shutdown checklist', tag:'PM', goal:1, days:[]}
        ];
        for(const h of defaults){
          const id='h'+Math.random().toString(36).slice(2,9);
          state.habits.push({id, name:h.name, tag:h.tag, days:h.days, goal:h.goal, archived:false});
          state.order.push(id);
          state.completions[id]={dates:{}};
        }
        await saveState();
      }

      renderAll();

      // Marcar dispositivo t√°ctil para fallback de reordenaci√≥n
      document.body.classList.toggle('touch', matchMedia('(pointer: coarse)').matches);

      // Bloquear al abrir si hay PIN
      if(state.security && state.security.pin){ showLock(); }
    })();

    function renderAll(){ renderToday(); renderHabits(); renderStats(); }

    // ===== Seguridad m√≠nima
    function escapeHtml(str){ return str.replace(/[&<>\"]/g, s=>({"&":"&amp;","<":"&gt;","">":"&quot;"}[s])); }

    // ===== iOS: altura real --vh y toast consciente del teclado
    (function iosVhFix(){
      const setVh = () => {
        const h = (window.visualViewport ? visualViewport.height : window.innerHeight);
        document.documentElement.style.setProperty('--vh', (h/100) + 'px');
      };
      setVh();
      window.addEventListener('resize', setVh);
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', setVh);
        visualViewport.addEventListener('scroll', setVh);
      }
    })();

    (function toastKeyboardAware(){
      const t = document.getElementById('toast');
      if (!t || !window.visualViewport) return;
      const adjust = () => {
        const kb = Math.max(0, window.innerHeight - visualViewport.height);
        t.style.bottom = `calc(${kb}px + env(safe-area-inset-bottom) + 20px)`;
      };
      visualViewport.addEventListener('resize', adjust);
      visualViewport.addEventListener('scroll', adjust);
    })();

    // ===== Service Worker (sw.js)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js', {scope:'./'})
          .then(r => console.log('SW registrado:', r.scope))
          .catch(err => console.warn('SW error', err));
      });
    }
  </script>
</body>
  
</html>
