<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Habit & Routine Tracker ‚Äî PRO (PWA + IndexedDB + PIN)</title>

  <!-- PWA & metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#60a5fa">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icon-512.png">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon-180.png">

  <!-- Social -->
  <meta property="og:title" content="Habit & Routine Tracker">
  <meta property="og:description" content="Seguimiento de h√°bitos simple, offline y privado. PWA + IndexedDB + PIN + backups.">
  <meta property="og:image" content="assets/og-image.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --card:#0b1225; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px }

    html,body{height:100%; min-height:-webkit-fill-available}
    body{
      margin:0; font:16px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b1225,#0f172a 30%,#0b1225);
      padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
      -webkit-text-size-adjust:100%; touch-action:manipulation;

      /* iOS viewport robusto */
      min-height: calc(var(--vh, 1vh) * 100);
      overscroll-behavior-y: contain;
      overflow-x: hidden;
    }
    /* Si el navegador soporta estas unidades, las usamos (el √∫ltimo bloque que aplique gana) */
    @supports (height: 100svh) { body { min-height: 100svh; } }
    @supports (height: 100dvh) { body { min-height: 100dvh; } }

    *{-webkit-tap-highlight-color:transparent}
    *, *::before, *::after{ box-sizing: border-box; }

    .container{max-width:1024px;margin:0 auto;padding:24px; padding-left:calc(24px + env(safe-area-inset-left)); padding-right:calc(24px + env(safe-area-inset-right))}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:20px;font-weight:700;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{background:var(--panel);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:999px;cursor:pointer}
    .tab-btn[aria-selected="true"]{outline:2px solid var(--brand)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card>.p{padding:16px}
    @media(min-width:720px){.half{grid-column:span 6}.third{grid-column:span 4}}
    .row{display:flex;align-items:center;gap:12px}
    .chip{font-size:12px;color:#0b1225;background:var(--brand);padding:2px 8px;border-radius:999px}
    .muted{color:var(--muted)}
    .spacer{flex:1}
    .btn{background:var(--brand);color:#081226;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#0b1225;color:var(--text);border:1px solid var(--border)}
    .btn.danger{background:#ef4444;color:white}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    input[type="text"], input[type="number"], input[type="password"], select, textarea{width:100%;background:#0b1225;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .item .streak{font-size:12px;color:var(--muted)}
    .heat{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .sq{width:18px;height:18px;border-radius:4px;background:#0d1b33;border:1px solid var(--border)}
    .sq.on{background:#22c55e}
    .small{font-size:12px}
    .footer{margin-top:24px;color:var(--muted);font-size:12px}
    .tag-AM{color:#08344a;background:#7dd3fc}
    .tag-PM{color:#3a0a2a;background:#f9a8d4}
    .tag-Any{color:#07361b;background:#86efac}
    .dow{display:flex; gap:6px; flex-wrap:wrap}
    .dow button{border:1px solid var(--border); background:#0b1225; color:#e5e7eb; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px}
    .dow button[aria-pressed="true"]{background:#14324d; outline:1px solid var(--brand)}
    .pill{font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px}
    .drag{cursor:grab; user-select:none}
    .archived{opacity:.6; filter:saturate(.6)}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(20px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0b1225;border:1px solid var(--border);box-shadow:var(--shadow);padding:10px 14px;border-radius:10px;display:none;gap:8px;align-items:center;z-index:9999}
    .toast.show{display:flex}

    /* Month heat calendar */
    .month{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cell{height:20px;border-radius:4px;border:1px solid var(--border);background:#0d1b33}
    .lvl1{background:#214d2b}
    .lvl2{background:#2f7d3e}
    .lvl3{background:#22c55e}
    .legend{display:flex;gap:8px;align-items:center}
    .legend .box{width:16px;height:16px;border-radius:4px;border:1px solid var(--border);}

    /* iOS reorder fallback */
    .reorder{display:none}
    body.touch .reorder{display:flex; gap:6px}
    .reorder .btn{padding:6px 8px}

    /* Lock overlay */
    #lock{position:fixed;inset:0;background:rgba(5,10,22,.75);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:99999; min-height:calc(var(--vh,1vh)*100)}
    #lock .panel{width:min(420px,92vw);background:#0b1225;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:18px}
    #lock h3{margin:0 0 6px 0}
    #lock .hint{color:var(--muted);font-size:12px}

    /* --- Fix layout H√°bitos (iPhone/estrecho) --- */
    .item{ flex-wrap: wrap; align-items: flex-start; }
    .item > input[type="text"]{ flex: 1 1 220px; min-width: 160px; }
    .item > select{ flex: 0 0 92px; }
    .item > input[type="number"]{ flex: 0 0 90px; }
    .dow{ flex: 1 1 240px; }
    .btn{ flex-shrink: 0; }
    .actions{ display:flex; gap:8px; margin-left:auto; flex: 0 0 auto; }
    @media (max-width: 430px){
      .actions{ flex-basis: 100%; justify-content: flex-end; margin-top: 8px; }
      .dow{ order: 5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">Habit & Routine Tracker</div>
        <div class="subtitle" id="greeting">Buenos d√≠as</div>
      </div>
      <nav class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab-btn" role="tab" id="tab-today" aria-selected="true" onclick="showTab('today')">Hoy</button>
        <button class="tab-btn" role="tab" id="tab-habits" aria-selected="false" onclick="showTab('habits')">H√°bitos</button>
        <button class="tab-btn" role="tab" id="tab-stats" aria-selected="false" onclick="showTab('stats')">Estad√≠sticas</button>
        <button class="tab-btn" role="tab" id="tab-review" aria-selected="false" onclick="showTab('review')">Revisi√≥n</button>
        <button class="tab-btn" role="tab" id="tab-backup" aria-selected="false" onclick="showTab('backup')">Copia/Restaurar</button>
      </nav>
    </header>

    <main class="grid">
      <!-- HOY -->
      <section id="panel-today" class="card">
        <div class="p">
          <div class="row" style="margin-bottom:10px">
            <div class="chip" id="daypart">AM</div>
            <div class="muted" id="today-date"></div>
            <span class="pill" id="persist-note" hidden>‚ö†Ô∏è A√±ade a Inicio para m√°s estabilidad</span>
            <div class="spacer"></div>
            <button class="btn secondary" onclick="toggleDaypartFilter()" title="Alternar filtro AM/PM">Cambiar AM/PM</button>
          </div>
          <div class="list" id="today-list"></div>
          <div class="footer">Si el h√°bito tiene objetivo &gt; 1, usa +/‚àí. La racha sube cuando alcanzas el objetivo del d√≠a.</div>
        </div>
      </section>

      <!-- H√ÅBITOS -->
      <section id="panel-habits" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Tus h√°bitos</h3>
          <div class="list" id="habit-list"></div>
          <hr style="border-color:var(--border); margin:16px 0"/>
          <div class="grid">
            <div class="half card" style="background:transparent; border:0; box-shadow:none">
              <div class="p">
                <h4 style="margin-top:0">A√±adir h√°bito</h4>
                <div class="row" style="gap:10px; align-items:flex-start; flex-wrap:wrap">
                  <input id="new-name" type="text" placeholder="Ej.: T√© verde" />
                  <select id="new-tag" style="max-width:140px">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                    <option value="Any">Cualquiera</option>
                  </select>
                  <input id="new-goal" type="number" value="1" min="1" step="1" style="max-width:120px" title="Objetivo diario (veces)" />
                  <button class="btn" onclick="addHabitFromUI()">A√±adir</button>
                </div>
                <div class="small muted" style="margin-top:6px">Puedes ajustar los d√≠as activos (L‚ÄìD) despu√©s.</div>
              </div>
            </div>
            <div class="half card" style="background:transparent; border:0; box-shadow:none">
              <div class="p">
                <h4 style="margin-top:0">Sugerencias</h4>
                <div class="row" style="flex-wrap:wrap; gap:8px">
                  <button class="tab-btn" onclick="quickAdd('T√© verde','AM')">T√© verde</button>
                  <button class="tab-btn" onclick="quickAdd('Caminata 30 min','AM')">Caminata 30‚Ä≤</button>
                  <button class="tab-btn" onclick="quickAdd('English 15','Any')">English 15</button>
                  <button class="tab-btn" onclick="quickAdd('Shutdown checklist','PM')">Shutdown</button>
                  <button class="tab-btn" onclick="quickAdd('Infusi√≥n de hinojo','PM')">Infusi√≥n hinojo</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ESTAD√çSTICAS -->
      <section id="panel-stats" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Estad√≠sticas</h3>
          <div id="stats-wrap" class="list"></div>
          <hr style="border-color:var(--border); margin:12px 0"/>
          <h4>Este mes</h4>
          <div class="month" id="month-heat"></div>
          <div class="legend small" style="margin-top:8px">
            <span class="muted">Adherencia por d√≠a:</span>
            <span class="box"></span>
            <span class="box lvl1"></span>
            <span class="box lvl2"></span>
            <span class="box lvl3"></span>
          </div>
        </div>
      </section>

      <!-- REVISI√ìN SEMANAL -->
      <section id="panel-review" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Revisi√≥n semanal</h3>
          <div class="small muted" id="week-label"></div>
          <div class="grid" style="margin-top:8px">
            <div class="half">
              <div class="card"><div class="p">
                <label class="small">Qu√© funcion√≥</label>
                <textarea id="rev-good" rows="3"></textarea>
                <label class="small">Qu√© ajusto</label>
                <textarea id="rev-adj" rows="3"></textarea>
                <label class="small">Un win</label>
                <textarea id="rev-win" rows="2"></textarea>
                <div class="row" style="margin-top:8px">
                  <button class="btn" onclick="saveReview()">Guardar</button>
                  <button class="btn secondary" onclick="clearReviewForm()">Limpiar</button>
                </div>
              </div></div>
            </div>
            <div class="half">
              <div class="card"><div class="p">
                <h4 style="margin-top:0">Historial</h4>
                <div id="rev-list" class="list"></div>
              </div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- BACKUP + PRIVACIDAD -->
      <section id="panel-backup" class="card" hidden>
        <div class="p">
          <h3 style="margin-top:0">Copia de seguridad / Restaurar</h3>
          <div class="grid">
            <div class="half">
              <div class="card"><div class="p">
                <p class="muted small">Exporta tus datos (copia/pega, descarga o comparte).</p>
                <textarea id="export-box" rows="8" readonly></textarea>
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="doExport()">Generar exportaci√≥n</button>
                  <button class="btn secondary" onclick="copyExport()">Copiar</button>
                  <button class="btn" onclick="downloadExport()">Descargar backup.json</button>
                  <button class="btn" onclick="shareExport()">Compartir‚Ä¶</button>
                </div>
                <hr style="border-color:var(--border); margin:12px 0"/>
                <h4 style="margin:0">Backup cifrado (AES-GCM)</h4>
                <input id="enc-pass" type="password" placeholder="Contrase√±a" />
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="downloadEncrypted()">Descargar .hrz</button>
                  <button class="btn secondary" onclick="shareEncrypted()">Compartir .hrz</button>
                </div>
              </div></div>
            </div>
            <div class="half">
              <div class="card"><div class="p">
                <p class="muted small">Restaurar desde archivo o pegando JSON. Puedes <strong>fusionar</strong> o <strong>reemplazar</strong>.</p>
                <div class="row" style="flex-wrap:wrap">
                  <input id="import-file" type="file" accept="application/json,.hrz" />
                  <label class="small"><input type="checkbox" id="merge-toggle" /> Fusionar (merge) en lugar de reemplazar</label>
                </div>
                <textarea id="import-box" rows="6" placeholder="Pega aqu√≠ tu JSON‚Ä¶"></textarea>
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="importFromFile()">Importar archivo</button>
                  <button class="btn danger" onclick="doImport()">Restaurar (pegar JSON)</button>
                  <button class="btn secondary" onclick="importEncrypted()">Importar .hrz</button>
                </div>
              </div></div>
            </div>
          </div>

          <hr style="border-color:var(--border); margin:16px 0"/>
          <h3 style="margin:0">Privacidad / Seguridad</h3>
          <p class="small muted">Tus datos viven s√≥lo en este dispositivo. Puedes bloquear la app con un <strong>PIN</strong> local (4‚Äì8 d√≠gitos). Si lo olvidas, s√≥lo podr√°s recuperar con tu backup.</p>
          <div class="grid">
            <div class="half">
              <div class="card"><div class="p">
                <h4 style="margin-top:0">PIN de apertura</h4>
                <input id="pin-1" inputmode="numeric" pattern="[0-9]*" type="password" placeholder="PIN (4‚Äì8 d√≠gitos)" maxlength="8" />
                <input id="pin-2" inputmode="numeric" pattern="[0-9]*" type="password" placeholder="Repite el PIN" maxlength="8" style="margin-top:8px" />
                <input id="pin-hint" type="text" placeholder="Pista (opcional)" style="margin-top:8px" />
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <button class="btn" onclick="enablePin()">Activar/Actualizar PIN</button>
                  <button class="btn secondary" onclick="disablePin()">Quitar PIN</button>
                </div>
                <div class="row" style="margin-top:8px; flex-wrap:wrap">
                  <label class="small">Auto-bloqueo: </label>
                  <select id="autolock" style="max-width:180px" onchange="setAutoLock(this.value)">
                    <option value="0">Nunca</option>
                    <option value="5">5 min</option>
                    <option value="10" selected>10 min</option>
                    <option value="30">30 min</option>
                  </select>
                </div>
              </div></div>
            </div>
            <div class="half">
              <div class="card"><div class="p">
                <h4 style="margin-top:0">Avisos</h4>
                <ul class="small">
                  <li>Instala la app (PWA) para reducir purgados de datos.</li>
                  <li>Haz backups regulares (mejor cifrados con contrase√±a).</li>
                  <li>Si olvidas el PIN, puedes <strong>borrar datos</strong> desde la pantalla de bloqueo y restaurar desde backup.</li>
                </ul>
              </div></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="footer" style="text-align:center; margin-top:24px">
      Local-first con <strong>IndexedDB</strong> (persistencia) y copia en <code>localStorage</code>. PWA instalable y offline en <strong>HTTPS</strong> o <code>localhost</code>.
    </div>
  </div>

  <div class="toast" id="toast"><span id="toast-msg">Hecho</span> <button class="btn secondary" onclick="undoAction()">Deshacer</button></div>

  <!-- Lock overlay -->
  <div id="lock">
    <div class="panel">
      <h3>üîí Desbloquear</h3>
      <div class="small muted">Introduce tu PIN para abrir la app.</div>
      <input id="lock-pin" inputmode="numeric" pattern="[0-9]*" type="password" placeholder="PIN" maxlength="8" style="margin-top:8px"/>
      <div class="row" style="margin-top:8px; flex-wrap:wrap">
        <button class="btn" onclick="tryUnlock()">Desbloquear</button>
        <button class="btn secondary" onclick="showHint()">Ver pista</button>
        <button class="btn danger" onclick="confirmNuke()">Borrar datos‚Ä¶</button>
      </div>
      <div id="lock-msg" class="hint" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ===== Utilidades
    const pad = n => (n<10? '0'+n : ''+n);
    function todayStr(){ const d = new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function dateOffsetStr(days){ const d = new Date(); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function humanDate(){ return new Date().toLocaleDateString('es-ES',{weekday:'l
